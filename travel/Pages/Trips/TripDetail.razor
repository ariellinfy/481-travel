@page "/trips/{id:int}"
@inject NavigationManager nav
@inject PageHistoryState PageHistoryState

<PageTitle>@TargetTrip.Name</PageTitle>

<div class="page-container" >
    <div class="page-header">
        @if (PageHistoryState.CanGoBack())
        {
            <button class="btn btn-round btn-back" @onclick="GoBack"><i class="bi bi-chevron-left"></i></button>
        }
        else
        {
            <button class="btn btn-round btn-transparent" disabled><i class="bi bi-chevron-left"></i></button>
        }
        <p class="text-wrap fs-3 page-title">@TargetTrip.Name</p>
        <div class="dropdown">
            <button class="btn btn-round btn-settings" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                    <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#rename">
                        Rename
                    </button>
                </li>
                <li>
                    <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#delete">
                        Delete
                    </button>
                </li>
            </ul>
        </div>
    </div>
    <div class="page-body">
        @foreach (KeyValuePair<string, List<Plan>> dayplans in plans)
            {
                <DayPlans PlanDate="@dayplans.Key" Plans="@dayplans.Value" />
            <hr />
            }
    </div>
    <div class="btn-fixed dropdown">
        <button class="btn btn-round btn-add" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-plus-lg"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-dark">
            <li>
                <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addPlan">
                    Add Plan
                </button>
            </li>
            <li>
                <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#quickAdd">
                    Quick Add
                </button>
            </li>     
        </ul>
    </div>
</div>

@code {
    [CascadingParameter]
    public StateModel state { get; set; }

    [CascadingParameter]
    public UserModel user { get; set; }

    public Trip TargetTrip { get; set; }

    private Plan NewPlan = new Plan();

    [Parameter]
    public int id { get; set; }

    Dictionary<string, List<Plan>> plans = new Dictionary<string, List<Plan>>();

    protected override void OnInitialized()
    {
        state.OnTab = 3;
        string currentUrl = "\\trips\\" + id;
        PageHistoryState.AddPageToHistory(currentUrl);
        TargetTrip = user.Trips[id];

        foreach(Plan plan in TargetTrip.Plans)
        {
            if (!plans.ContainsKey(plan.Date))
            {
                plans.Add(plan.Date, new List<Plan>());
                plans[plan.Date].Add(plan);
            }
            else
            {
                plans[plan.Date].Add(plan);
            }
        }
    }

    private void Delete()
    {
        user.Trips.Remove(TargetTrip);
        nav.NavigateTo("/trips");
    }

    private void GoBack()
    {
        @if (PageHistoryState.CanGoBack())
        {
            string backPage = PageHistoryState.GetGoBackPage();
            nav.NavigateTo(backPage);
        }
    }

    private void ValidatePlanCreation()
    {
        TargetTrip.Plans.Add(NewPlan);
        NewPlan = new Plan();
    }
}

<div class="modal fade" id="rename" aria-hidden="true" aria-labelledby="newTripLabel" tabindex="-1">
    <div id="modal-center" class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-background">
            <div class="modal-body">
                <div class="trip-form">
                    <h5 class="create-option">Rename Trip <b>@TargetTrip.Name</b></h5>
                    <div class="form-floating mt-3 mb-3">
                        <input @bind="TargetTrip.Name" class="form-control" id="tripName" placeholder="Happy Trip" />
                        <label for="tripName">Trip Name</label>
                    </div>
                    <div class="form-controls modal-footer">
                        <button type="button" class="btn btn-close-variant btn-outline-dark" data-bs-dismiss="modal" aria-label="Close">Close</button>
                        <button type="button" class="btn btn-save" data-bs-target="#tripSuccess" data-bs-toggle="modal">Create New Trip</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="delete" aria-hidden="true" aria-labelledby="newTripLabel" tabindex="-1">
    <div id="modal-center" class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-background">
            <div class="modal-body">
                <div class="trip-form">
                    <h5 class="create-option">Are you sure to delete the <b>@TargetTrip.Name</b> Trip?</h5>
                    <div class="form-controls modal-footer">
                        <button type="button" class="btn btn-close-variant btn-outline-dark" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                        <button type="button" class="btn btn-save" data-bs-target="#tripSuccess" data-bs-toggle="modal" @onclick="Delete">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPlan" tabindex="-1" aria-labelledby="addPlanLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content add-new-plan">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Add a Plan</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="new-plan" class="modal-body">
                <div class="plan-form">
                    <div class="form-floating mb-3">
                        <input type="text" @bind="@NewPlan.Name" class="form-control" id="activityName" placeholder="unknown" required>
                        <label for="activityName">Activity Name</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="datetime-local" class="form-control" id="startDate&Time" required>
                        <label for="startDate&Time">Start Date & Time</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="datetime-local" class="form-control" id="endDate&Time" required>
                        <label for="endDate&Time">End Date & Time</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="text" @bind="@NewPlan.Address" class="form-control" id="address" placeholder="unknown">
                        <label for="address">Address</label>
                    </div>

                    <div class="form-floating">
                        <textarea class="form-control" @bind="@NewPlan.Notes" placeholder="N/A" id="notes" style="height: 100px"></textarea>
                        <label for="notes">Notes</label>
                    </div>

                    <button type="button" class="btn btn-save">Save</button>
                    <button type="button" class="btn btn-save" data-bs-target="#tripSuccess" data-bs-toggle="modal" @onclick="ValidatePlanCreation">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quickAdd" tabindex="-1" aria-labelledby="quickAddLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content add-new-plan">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Quick Add</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="quick-add" class="modal-body">
@*                <QuickAddCard planImg="@img1" planName="@name1" planDetail="@detail1" />
                <QuickAddCard planImg="@img3" planName="@name3" planDetail="@detail3" />
                <QuickAddCard planImg="@img2" planName="@name2" planDetail="@detail2" />
                <QuickAddCard planImg="@img5" planName="@name5" planDetail="@detail5" />
                <QuickAddCard planImg="@img4" planName="@name4" planDetail="@detail4" />*@
            </div>
        </div>
    </div>
</div>